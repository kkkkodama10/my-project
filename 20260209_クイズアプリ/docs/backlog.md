# バックログ

- [セキュリティ・信頼性リスク](#セキュリティ信頼性リスク)
- [機能的バックログ](#機能的バックログ)
- [技術的負債](#技術的負債)

---

# セキュリティ・信頼性リスク

## CRITICAL（即対応推奨）

| # | リスク | 対象ファイル | 概要 | 攻撃シナリオ |
|---|--------|-------------|------|-------------|
| 1 | デフォルトパスワード "secret" | config.py:38 | `ADMIN_PASSWORD` のデフォルト値がハードコード | 環境変数未設定のまま本番デプロイ → 誰でも管理者ログイン可能 |
| 2 | セッショントークン生成が uuid4 | admin.py:181 | `uuid.uuid4().hex` は暗号学的に安全ではない | トークン推測によるセッションハイジャック |
| 3 | Cookie に secure フラグ未設定 | events.py:67, admin.py:184 | ユーザー・管理者 Cookie に `secure` / `samesite` フラグなし | HTTP 通信での中間者攻撃によるセッション盗取 |

## HIGH（本番前に対応）

| # | リスク | 対象ファイル | 概要 | 攻撃シナリオ |
|---|--------|-------------|------|-------------|
| 4 | ログイン試行制限がインメモリ | admin.py:111-128 | ロックアウトが Python リストで管理。再起動でリセット | ECS 複数タスク環境で タスク数×5回 のブルートフォース |
| 5 | 公開エンドポイントにレート制限なし | events.py:49-111 | `/join`, `/users/register` に制限なし | 大量ボット登録、DB 負荷攻撃 |
| 6 | 入力値バリデーション不足 | 各 schemas/ | Pydantic スキーマに max_length 等の制約なし | 巨大文字列 DoS、HTML/Script 挿入 |
| 7 | CSV インジェクション | ranking_service.py:108-125 | display_name をエスケープせず CSV 出力 | `=cmd\|'/c calc'!A0` 等の登録 → Excel でコマンド実行 |
| 8 | CORS + CSRF 対策なし | main.py:41-47 | `allow_credentials=True` + CSRF トークンなし | 攻撃者サイトから管理者 Cookie で API 呼び出し（Reset/Abort 等） |
| 9 | 画像アップロード検証不足 | admin.py:406-429 | マジックバイト検証なし、ファイルサイズ制限なし | 悪意あるファイルアップロード、ディスク枯渇 |
| 10 | WebSocket に認証なし | ws.py:14-30 | session_id 空でも接続可能 | `ws?event_id=demo` で問題内容・正解をリアルタイム傍受 |
| 11 | 出題中の問題を編集可能 | admin.py:325-376 | イベント進行中でも選択肢・正解を変更可能 | 回答済み参加者の結果が矛盾 |

## MEDIUM（運用上の注意）

| # | リスク | 対象ファイル | 概要 | 攻撃シナリオ |
|---|--------|-------------|------|-------------|
| 12 | 結果エンドポイントに認証なし | events.py:158 | `/events/{event_id}/results` が認証不要 | event_id 総当たりで全参加者名・スコア取得 |
| 13 | Valkey 障害時のサイレント劣化 | valkey_manager.py:44 | 再接続・リトライロジックなし | ElastiCache 障害 → インメモリフォールバック → タスク間セッション不整合 |
| 14 | リクエストサイズ制限なし | main.py | `max_request_size` 未設定 | 1GB POST body でメモリ枯渇 → コンテナクラッシュ |
| 15 | ドキュメント内に接続情報記載 | MS3_implementation_summary.md | RDS/Valkey エンドポイント・パスワード例が記載 | リポジトリ公開時に漏洩 |
| 16 | 監査ログが永続化されていない | admin.py:146 | ログイン失敗・操作ログがメモリ上のみ | インシデント発生時のフォレンジック調査不可 |
| 17 | ログインのタイミング攻撃 | admin.py:175 | admin 存在有無で bcrypt 処理時間が異なる | レスポンス時間差でアカウント存在を推測 |

---

# 機能的バックログ

## Phase 3 ブロッカー

| # | 項目 | 対象ファイル | 概要 | 影響 |
|---|------|-------------|------|------|
| F1 | WS Manager が切り替わらない | dependencies.py:20 | `ConnectionManager`（インメモリ）がハードコード。`ValkeyConnectionManager` が配線されていない | ECS 複数タスクで WS ブロードキャストが各タスク内に閉じる |
| F2 | イベントID "demo" がフロントにハードコード | JoinPage.jsx:6, AdminDashboard.jsx:7 | `const EVENT_ID = 'demo'` 固定 | マルチイベント運用不可 |
| F3 | Alembic マイグレーションが未整備 | （alembic/ ディレクトリなし） | MS3 ドキュメントに記載はあるが実体がない | RDS デプロイ時に DB スキーマ適用不可 |
| F4 | DI が具象クラスを返している | dependencies.py:26-96 | `get_event_store()` 等が `SQLite*Store` を直接返す | PostgreSQL Store への切替にコード変更が必要 |

## 機能的な欠落・不備

| # | 項目 | 対象ファイル | 概要 | 影響 |
|---|------|-------------|------|------|
| F5 | 表示名の重複回避が不完全 | events.py:38-43 | サフィックス生成が10回試行後、重複を無視して返す | 参加者名が重複する可能性 |
| F6 | 進行中の問題が編集可能 | admin.py:325-376 | アクティブな問題かチェックせず更新を許可 | 回答済み参加者の結果が矛盾 |
| F7 | エラーメッセージが汎用的 | JoinPage.jsx:93 | ネットワーク・バリデーション・サーバーエラーすべて同じ表示 | ユーザーが原因を判断できない |
| F8 | API 呼び出し中のローディング表示なし | 各フロントエンドページ | フォーム送信時にインジケータがない | 二重送信の原因 |
| F9 | ネットワークタイムアウト未設定 | api/client.js:11 | fetch に timeout オプションなし | 低速回線でハングする |
| F10 | API レスポンス形式の検証なし | api/client.js:5-17 | レスポンスのフォーマットを検証していない | 想定外レスポンスでフロントがクラッシュ |

---

# 技術的負債

## コード品質

| # | 項目 | 対象ファイル | 概要 | 影響 |
|---|------|-------------|------|------|
| T1 | グローバル可変状態（スレッド安全性） | admin.py:44, 115 | `_admin_sessions` dict, `_failed_attempts` list がロックなしで共有 | 並行リクエストで競合状態 |
| T2 | `print()` が残存 | image_service.py:133,149 / valkey_manager.py:109 | `logging` モジュールではなく `print()` を使用 | CloudWatch にログが出ない、レベル制御不可 |
| T3 | 例外の丸呑み | admin.py:57,65 / manager.py:49 / valkey_manager.py:108 | `except Exception` で握りつぶし | 障害の原因調査が困難 |
| T4 | 非同期/同期の混在 | image_service.py:62,90 / admin.py:426 | `async def` 内で同期 I/O（`open()`, boto3 `put_object()`） | イベントループのブロッキング |
| T5 | AdminStore に基底クラスなし | store/sqlite_store.py | Event/Question/User/Answer は `Base*Store` 継承だが Admin は直接実装 | PostgreSQL 版への差し替えにリファクタ必要 |
| T6 | ORM リレーション未定義 | models/event.py | `Event` → `EventQuestion` のリレーションがない | 生 SQL に頼る必要あり |

## 依存関係・構成

| # | 項目 | 対象ファイル | 概要 | 影響 |
|---|------|-------------|------|------|
| T7 | 依存バージョンが緩い | requirements.txt | `fastapi>=0.109.0` 等ピン留めなし | 再ビルドで互換性が壊れる可能性 |
| T8 | フロントエンドが TypeScript 未採用 | frontend/src/**/*.jsx | JavaScript（JSX）のみ | 型安全性なし、IDE 補完が弱い |
| T9 | CORS_ORIGINS のパースが脆弱 | config.py:40-41 | カンマ区切りの単純 split | URL にカンマを含むケースで誤動作（エッジケース） |

## テストのギャップ

| # | 項目 | 概要 | 影響 |
|---|------|------|------|
| T10 | WebSocket 認証のテストなし | session_id 空で接続可能な問題がテストで検出されていない | 認可バイパスが未検出 |
| T11 | 画像アップロードのテストなし | マジックバイト偽装のテストケースがない | 悪意あるファイルが未検出 |
| T12 | Phase 3 構成の統合テストなし | PostgreSQL / Redis 環境でのテストが存在しない | RDS + Valkey デプロイ時のバグ未検出 |

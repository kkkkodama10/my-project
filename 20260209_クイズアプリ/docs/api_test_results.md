# APIテスト実施結果

**実施日時**: 2026-02-19
**環境**: https://dasrqxsst4jru.cloudfront.net
**テスト方法**: curl コマンドによる手動テスト

---

## 1. ヘルスチェック

| # | テスト内容 | メソッド / パス | 結果 | 備考 |
|---|-----------|----------------|------|------|
| 1 | ヘルスチェック応答 | `GET /api/health` | ✅ OK | `{"status":"ok"}` 返却 |
| 2 | ルート応答 | `GET /` | ✅ OK | フロントエンドHTML返却 |

---

## 2. 参加者フロー (Events)

### イベント参加 (`POST /api/events/{event_id}/join`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 正しい join_code で参加 | ✅ OK | 200, session_id Cookie 発行, イベント情報返却 |
| 2 | 異常 | 誤った join_code | ⚠️ PARTIAL | CloudFrontが404をフロントエンドにフォールバック（SPAルーティング） |
| 3 | 異常 | 存在しない event_id | ⚠️ PARTIAL | 同上 |
| 4 | 異常 | join_code 未指定（空文字） | 🔲 未実施 | |
| 5 | 異常 | イベント状態が aborted | 🔲 未実施 | |

### ユーザー登録 (`POST /api/events/{event_id}/users/register`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | display_name_base を指定して登録 | 🔲 未実施 | 要セッション |
| 2 | 異常 | session_id Cookie なし | 🔲 未実施 | |
| 3 | 異常 | 無効な session_id | 🔲 未実施 | |
| 4 | 異常 | イベント終了後に登録 | 🔲 未実施 | |
| 5 | 異常 | display_name_base 未指定 | 🔲 未実施 | |
| 6 | 異常 | 同一セッションで二重登録 | 🔲 未実施 | |

### ユーザー状態取得 (`GET /api/events/{event_id}/me/state`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | waiting 状態で取得 | 🔲 未実施 | イベント状態がfinished |
| 2 | 正常 | running 状態 + 出題中に取得 | 🔲 未実施 | 同上 |
| 3 | 正常 | 回答済みの状態で取得 | 🔲 未実施 | 要セッション |
| 4 | 正常 | reveal 後に取得 | 🔲 未実施 | 同上 |
| 5 | 異常 | session_id Cookie なし | 🔲 未実施 | |
| 6 | 異常 | 存在しない event_id | 🔲 未実施 | |

### 回答送信 (`POST /api/events/{event_id}/questions/{question_id}/answers`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-9 | 全項目 | - | 🔲 未実施 | イベント進行中の状態が必要 |

### 結果取得 (`GET /api/events/{event_id}/results`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 終了済みイベントのリーダーボード取得 | ✅ OK | 200, rank 順にソート済み、2名の参加者データ確認 |
| 2 | 正常 | 同点のユーザーがいる場合 | 🔲 未実施 | テストデータに同点なし |
| 3 | 異常 | 未終了イベントの結果取得 | 🔲 未実施 | |
| 4 | 異常 | 存在しない event_id | ⚠️ PARTIAL | CloudFrontがフロントエンドにフォールバック |

**結果サンプル**:
```json
{
  "rank": 1,
  "user_id": "6914cf281fa04c41920bdf76927e35b4",
  "display_name": "guest-2380",
  "correct_count": 4,
  "unanswered_count": 0,
  "accuracy": 0.8,
  "correct_time_sum_sec_1dp": 3.5
}
```

### CSV エクスポート (`GET /api/events/{event_id}/results/csv`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | CSV ダウンロード | ✅ OK | Content-Type=text/csv, BOM 付き UTF-8 |
| 2 | 正常 | CSV のカラム確認 | ✅ OK | 順位,表示名,正解数,未回答数,正答率,回答時間合計(秒) |
| 3 | 異常 | 存在しない event_id | ⚠️ PARTIAL | CloudFrontがフロントエンドにフォールバック |

**CSVサンプル**:
```
順位,表示名,正解数,未回答数,正答率,回答時間合計(秒)
1,guest-2380,4,0,80.0%,3.5
2,guest-4593,0,5,0.0%,0.0
```

### 現在の問題取得 (`GET /api/events/{event_id}/questions/current`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 出題中に取得 | 🔲 未実施 | イベント状態がfinished |
| 2 | 正常 | 出題なし（waiting 状態） | ✅ OK | event_state="finished", question=最終問題データ |
| 3 | 異常 | 存在しない event_id | ⚠️ PARTIAL | CloudFrontフォールバック |

### ログアウト (`POST /api/events/{event_id}/logout`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | ログアウト成功 | 🔲 未実施 | 要セッション |
| 2 | 異常 | session_id Cookie なし | 🔲 未実施 | |

---

## 3. 管理者フロー (Admin)

### ログイン (`POST /api/admin/login`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 正しいパスワードでログイン | ✅ OK | 200, admin_session Cookie 発行 |
| 2 | 異常 | 誤ったパスワード | ✅ OK | `{"detail":"invalid password"}` |
| 3 | 異常 | パスワード未指定 | 🔲 未実施 | |
| 4 | 異常 | 5回連続失敗後にログイン試行 | 🔲 未実施 | レート制限テストは破壊的 |
| 5 | 正常 | レート制限解除後（15分後）にログイン | 🔲 未実施 | |

### セッション検証 (`GET /api/admin/verify`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 有効な admin_session で検証 | ✅ OK | `{"status":"ok"}` |
| 2 | 異常 | Cookie なし | 🔲 未実施 | |
| 3 | 異常 | 期限切れ Cookie（24時間超過） | 🔲 未実施 | |
| 4 | 異常 | 改ざんされた Cookie 値 | 🔲 未実施 | |

### イベント作成 (`POST /api/admin/events`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-5 | 全項目 | - | 🔲 未実施 | |

### 参加コード更新 (`PUT /api/admin/events/{event_id}/join-code`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### イベント開始 (`POST /api/admin/events/{event_id}/start`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### 次の問題 (`POST /api/admin/events/{event_id}/questions/next`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-4 | 全項目 | - | 🔲 未実施 | |

### 問題締切 (`POST /api/admin/events/{event_id}/questions/{question_id}/close`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### 正解表示 (`POST /api/admin/events/{event_id}/questions/{question_id}/reveal`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### イベント終了 (`POST /api/admin/events/{event_id}/finish`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### イベントリセット (`POST /api/admin/events/{event_id}/reset`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-2 | 全項目 | - | 🔲 未実施 | |

### イベント中止 (`POST /api/admin/events/{event_id}/abort`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-2 | 全項目 | - | 🔲 未実施 | |

### 問題一覧 (`GET /api/admin/questions`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 全問題取得 | ✅ OK | 200, 5件の問題リスト返却 |
| 2 | 正常 | enabled_only=true で絞り込み | 🔲 未実施 | |
| 3 | 異常 | 管理者認証なし | ✅ OK | `{"detail":"admin auth required"}` |

**問題サンプル**:
```json
{
  "question_id": "q1",
  "question_text": "日本の首都はどこですか？",
  "is_enabled": true
}
```

### 問題作成 (`POST /api/admin/questions`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 必須項目を指定して作成 | ✅ OK | 200, 問題ID: c48b8c198193488ba4860207612c9a00 |
| 2 | 異常 | question_text 未指定 | ✅ OK | `{"detail":[{"type":"missing","loc":["body","question_text"],...}]}` |
| 3 | 異常 | choices が4つ未満 | ✅ OK | `{"detail":"exactly 4 choices required"}` |
| 4 | 異常 | correct_choice_index が範囲外 | 🔲 未実施 | |
| 5 | 異常 | 管理者認証なし | 🔲 未実施 | |

**作成した問題**:
```json
{
  "question_id": "c48b8c198193488ba4860207612c9a00",
  "question_text": "APIテスト問題: 1+1は？",
  "correct_choice_index": 1
}
```

### 問題更新 (`PUT /api/admin/questions/{question_id}`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | question_text を更新 | ✅ OK | 200, 更新後の問題返却 |
| 2 | 正常 | 一部フィールドのみ更新（partial update） | ✅ OK | question_textのみ更新確認 |
| 3 | 異常 | 存在しない question_id | 🔲 未実施 | |
| 4 | 異常 | 管理者認証なし | 🔲 未実施 | |

**更新後**:
```json
{
  "question_id": "c48b8c198193488ba4860207612c9a00",
  "question_text": "APIテスト問題（更新済み）: 1+1は？"
}
```

### 問題有効/無効化 (`PUT /api/admin/questions/{question_id}/enabled`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | 問題を無効化 | ✅ OK | `is_enabled: false` 確認 |
| 2 | 正常 | 問題を有効化 | 🔲 未実施 | |
| 3 | 異常 | 存在しない question_id | 🔲 未実施 | |
| 4 | 異常 | 管理者認証なし | 🔲 未実施 | |

### 問題並び替え (`PUT /api/admin/questions/reorder`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-3 | 全項目 | - | 🔲 未実施 | |

### 画像アップロード (`POST /api/admin/assets/images`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-5 | 全項目 | - | 🔲 未実施 | multipart/form-data 必要 |

### 監査ログ (`GET /api/admin/logs`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1 | 正常 | ログ取得（デフォルト100件） | ✅ OK | 200, ログリスト返却 |
| 2 | 正常 | limit パラメータ指定 | ✅ OK | limit=3で3件取得 |
| 3 | 異常 | 管理者認証なし | 🔲 未実施 | |

**ログサンプル**:
```json
{
  "ts": "2026-02-19T12:44:14.052535+00:00",
  "action": "set_question_enabled"
},
{
  "ts": "2026-02-19T12:44:01.000588+00:00",
  "action": "update_question"
},
{
  "ts": "2026-02-19T12:43:53.511632+00:00",
  "action": "create_question"
}
```

---

## 4. WebSocket (`WS /api/ws?event_id={event_id}`)

| # | 種別 | テスト内容 | 結果 | 備考 |
|---|------|-----------|------|------|
| 1-10 | 全項目 | - | 🔲 未実施 | WSはcurlでテスト不可、Browser useで実施推奨 |

---

## テスト実施可否サマリー

### ✅ 実施可能（curl で完了）
- ヘルスチェック
- 管理者ログイン（正常・異常）
- 管理者セッション検証
- 問題一覧取得
- 問題作成・更新・有効無効化
- バリデーションエラー確認
- 結果取得・CSVエクスポート
- 監査ログ取得
- 現在の問題取得
- 認証なしアクセステスト

### 🔲 未実施（理由別）

**イベント状態依存**:
- イベント作成・開始・進行・終了・リセット・中止
- 回答送信関連のすべてのテスト
- ユーザー登録・状態取得（要セッション）

**CloudFront の SPA フォールバック**:
- 存在しないリソースへのアクセス（404が返らずフロントエンドHTML返却）
- 誤った参加コードでのエラーレスポンス確認

**技術的制約**:
- WebSocket テスト（curl 非対応）
- 画像アップロード（multipart/form-data）

**破壊的テスト**:
- レート制限（5回失敗で15分ロック）

### ⚠️ 部分実施
- イベント参加（正常系のみ、異常系はCloudFrontのSPAフォールバックで正確なテスト不可）
- 結果取得・CSV（存在しないevent_idのエラーハンドリング確認不可）

---

## 推奨次ステップ

1. **Browser use でのUIテスト** → イベント作成・進行・参加フローの統合テスト
2. **WebSocket テスト** → Browser use または専用ツール（wscat等）で実施
3. **CloudFront設定の見直し** → API の 404/403 エラーが正しく返るよう調整（SPAフォールバックの範囲を限定）
4. **セッション管理テスト** → ユーザー登録・状態取得・ログアウトの一連フロー
5. **画像アップロード** → curlまたはPostman等でmultipart/form-dataテスト

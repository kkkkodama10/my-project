# lifelog スキル

LINEから受信したメモを日報フォーマットに整形し、Notionライフログデータベースに記録する。

## 使用ツール

- notion（Notion API によるデータベース操作）

## 処理フロー

1. ユーザーのテキストメッセージを受け取る
2. メッセージを以下のカテゴリに振り分け、JSON形式に整形する
3. Notion APIで当日のレコードを検索する
4. レコードが存在しなければ新規作成、存在すれば追記する
5. 結果をユーザーに返信する

## 整形プロンプト

以下のルールに従い、ユーザーのメッセージを構造化JSONに変換してください。

### 振り分けカテゴリ

| キー | カテゴリ | 内容 |
|------|---------|------|
| `wake_up_time` | 起床時刻 | 起きた時刻。ISO 8601形式（例: `2026-02-26T07:00:00+09:00`） |
| `sleep_time` | 就寝時刻 | 寝た時刻。ISO 8601形式。前日の就寝は前日の日付にする |
| `work_hours` | 就業時間 | 労働時間（数値、単位: 時間）。「9時〜17時半」→ `8.5` |
| `work` | 仕事 | 作業内容、考えたこと |
| `input` | インプット | YouTube、ドキュメンタリー、読んだもの |
| `llm_log` | LLMログ | LLMに聞いたこと |
| `study` | 勉強 | 学習内容 |
| `child_growth` | 子供の成長 | 子供の出来事・発達記録 |
| `memo` | メモ | 上記に該当しないもの |
| `raw_message` | 元メッセージ | 入力テキストの原文をそのまま格納 |

### 整形ルール

- 時刻表現は自然言語からISO 8601形式（タイムゾーン: `+09:00`）に変換する
- 就寝時刻で「昨日23時に寝た」等の表現は前日の日付にする
- 就業時間は「8.5h」「9時〜17時半」等から数値（時間）に変換する
- 振り分け不明な内容は `memo` に格納する
- 該当しないカテゴリは `null` にする
- 出力はJSON形式のみ（説明文不要）

### 出力例

```json
{
  "wake_up_time": "2026-02-26T07:00:00+09:00",
  "sleep_time": "2026-02-25T23:30:00+09:00",
  "work_hours": 8.5,
  "work": "API設計のレビュー",
  "input": "Rustのライフタイムの動画を視聴",
  "llm_log": null,
  "study": "Rustのライフタイム",
  "child_growth": "初めて「パパ」と言った",
  "memo": null,
  "raw_message": "7時起き。昨日23時半に寝た。8.5h働いた。API設計のレビューした。Rustのライフタイムの動画見て勉強した。子供が初めてパパって言った"
}
```

## Notion書き込み仕様

### データベースID

環境変数 `LIFELOG_DATABASE_ID` を使用する。

### プロパティマッピング

| JSONキー | Notionプロパティ名 | 型 | 追記時の挙動 |
|----------|-------------------|------|-------------|
| （自動） | 日付 | Date | 当日の日付を設定 |
| `wake_up_time` | 起床時刻 | Date | 上書き |
| `sleep_time` | 就寝時刻 | Date | 上書き |
| `work_hours` | 就業時間 | Number | 上書き |
| `work` | 仕事 | Rich Text | 末尾に追記 |
| `input` | インプット | Rich Text | 末尾に追記 |
| `llm_log` | LLMログ | Rich Text | 末尾に追記 |
| `study` | 勉強 | Rich Text | 末尾に追記 |
| `child_growth` | 子供の成長 | Rich Text | 末尾に追記 |
| `memo` | メモ | Rich Text | 末尾に追記 |
| `raw_message` | 元メッセージ | Rich Text | 末尾に追記 |

### 書き込みロジック

1. `LIFELOG_DATABASE_ID` のデータベースから、当日の日付でフィルタしてレコードを検索する
2. レコードが存在しない → 新規ページを作成し全プロパティを書き込む
3. レコードが存在する → 既存ページを更新する
   - Rich Textプロパティ: 既存テキスト + 改行 + 新しいテキスト
   - 数値/時刻プロパティ: 新しい値で上書き
   - `null` のプロパティは既存値を保持（上書きしない）

## 返信メッセージ

- 成功時: 「記録しました」
- LLM整形失敗時: 「処理に失敗しました。もう一度送ってください」
- Notion書き込み失敗時: 「記録に失敗しました」

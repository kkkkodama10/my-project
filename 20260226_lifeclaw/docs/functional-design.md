# 機能設計書

## 機能一覧

| # | 機能名 | 概要 |
|---|--------|------|
| F1 | メッセージ受信 | LINEからのWebhookを受信しテキストを抽出する |
| F2 | ログ整形 | LLMでメモを日報フォーマットに整形・振り分けする |
| F3 | Notion書き込み | 整形結果をNotionデータベースに書き込む（新規作成 or 追記） |
| F4 | リマインド送信 | 毎日定時にLINEでリマインド通知を送る |

---

## F1: メッセージ受信

### トリガー

ユーザーがLINE BotにテキストメッセージまたはLINE URLスキームを送信する。

### 入力

- LINE Webhook イベント（`message` タイプ、`text` サブタイプ）

### 処理フロー

1. LINE Messaging APIからWebhookイベントを受信する
2. 署名検証（チャネルシークレット）でリクエストの正当性を確認する
3. イベントからテキストメッセージを抽出する
4. 抽出したテキストをF2（ログ整形）に渡す

### 出力

- 抽出されたテキストメッセージ（文字列）

### エラーケース

| ケース | 対応 |
|--------|------|
| 署名検証失敗 | 400を返却し処理を中断する |
| テキスト以外のメッセージ（画像・スタンプ等） | 「テキストメッセージを送ってください」とLINEで返信する |
| 空メッセージ | 無視する（応答なし） |

---

## F2: ログ整形

### トリガー

F1からテキストメッセージを受け取る。

### 入力

- ユーザーの雑なテキストメッセージ（フォーマット自由）
- 現在の日時（タイムゾーン: Asia/Tokyo）

### 処理フロー

1. LLM（Claude Sonnet/Haiku）にテキストと整形指示を送信する
2. LLMが以下のプロパティに自動振り分けする:
   - 起床時刻 — 「7時に起きた」→ `2026-02-26T07:00:00+09:00`
   - 就寝時刻 — 「23時半に寝た」→ 前日の `2026-02-25T23:30:00+09:00`
   - 就業時間 — 「8.5h働いた」→ `8.5`、「9時〜17時半」→ `8.5`
   - 仕事 — 業務内容の記述
   - インプット — 読んだ/見たもの
   - LLMログ — LLMに聞いたこと
   - 勉強 — 学習内容
   - 子供の成長 — 子供に関する記述
   - メモ — 上記に該当しないもの
3. LLMの出力をJSON形式で受け取る

### LLMプロンプト設計（概要）

- 入力テキストを読み、各プロパティに振り分ける
- 時刻表現は自然言語からISO 8601形式に変換する
- 就寝時刻で前日を示唆する表現（「昨日23時に寝た」等）は前日の日付にする
- 振り分け不明な内容は「メモ」に格納する
- 値が該当しないプロパティは `null` とする
- 出力はJSON形式とする

### 出力（JSON構造）

```json
{
  "wake_up_time": "2026-02-26T07:00:00+09:00",
  "sleep_time": "2026-02-25T23:30:00+09:00",
  "work_hours": 8.5,
  "work": "API設計のレビュー",
  "input": "Rustのライフタイムの動画",
  "llm_log": null,
  "study": "Rustのライフタイム",
  "child_growth": "初めて「パパ」と言った",
  "memo": null,
  "raw_message": "（元メッセージ原文）"
}
```

### エラーケース

| ケース | 対応 |
|--------|------|
| LLM APIエラー | LINEで「処理に失敗しました。もう一度送ってください」と返信する |
| JSON解析失敗 | リトライ（最大1回）。失敗時はメモプロパティに原文をそのまま格納する |

---

## F3: Notion書き込み

### トリガー

F2から整形済みJSONを受け取る。

### 入力

- F2の出力JSON
- Notionデータベース ID（環境変数 `LIFELOG_DATABASE_ID`）

### 処理フロー

1. Notion APIで対象日付のレコードを検索する
2. **レコードが存在しない場合**: 新規ページを作成し、全プロパティを書き込む
3. **レコードが存在する場合**: 既存プロパティに追記する
   - Rich Textプロパティ: 既存テキストの末尾に改行 + 新しいテキストを追加する
   - 数値プロパティ（就業時間）: 後の値で上書きする
   - 時刻プロパティ（起床/就寝）: 後の値で上書きする
   - `null` のプロパティは既存値を保持する（上書きしない）
4. 元メッセージ（`raw_message`）は常に追記する（送信履歴として）

### プロパティマッピング

| JSON キー | Notion プロパティ | 型 | 追記時の挙動 |
|-----------|------------------|------|-------------|
| （自動） | 日付 | Date | 当日の日付を設定 |
| `wake_up_time` | 起床時刻 | Date | 上書き |
| `sleep_time` | 就寝時刻 | Date | 上書き |
| `work_hours` | 就業時間 | Number | 上書き |
| `work` | 仕事 | Rich Text | 追記 |
| `input` | インプット | Rich Text | 追記 |
| `llm_log` | LLMログ | Rich Text | 追記 |
| `study` | 勉強 | Rich Text | 追記 |
| `child_growth` | 子供の成長 | Rich Text | 追記 |
| `memo` | メモ | Rich Text | 追記 |
| `raw_message` | 元メッセージ | Rich Text | 追記 |

### 出力

- 書き込み成功: LINEで「記録しました」と返信する
- 書き込み失敗: LINEで「記録に失敗しました」と返信する

### エラーケース

| ケース | 対応 |
|--------|------|
| Notion APIエラー（認証失敗） | LINEでエラー通知し処理を中断する |
| Notion APIエラー（レート制限） | 3秒待ってリトライ（最大2回） |
| データベース未検出 | LINEでエラー通知し処理を中断する |

---

## F4: リマインド送信

### トリガー

OpenClaw cronジョブ（毎日 22:00 JST）。

### 入力

なし（固定メッセージ）。

### 処理フロー

1. cronジョブが定時に起動する
2. 固定メッセージをLINE Messaging APIで送信する

### 出力

- LINEメッセージ: 「📝 今日のログを書こう！仕事・インプット・睡眠・子供の成長、何でもOK。」

### 設計上の判断

- LLM呼び出しなし（固定メッセージ出力のみ）でトークンコストゼロ
- isolatedセッションでメインの会話コンテキストを汚さない

---

## 全体フロー図

```
[ユーザー]
    │
    │ LINEでメモ送信
    ▼
[F1: メッセージ受信]
    │ テキスト抽出
    ▼
[F2: ログ整形]
    │ LLMでJSON化
    ▼
[F3: Notion書き込み]
    │ 新規作成 or 追記
    ▼
[Notion DB] ──── 記録完了 ───▶ [LINE返信: 「記録しました」]


[OpenClaw Cron (22:00 JST)]
    │
    ▼
[F4: リマインド送信] ───▶ [LINE通知: 「📝 今日のログを書こう！」]
```
